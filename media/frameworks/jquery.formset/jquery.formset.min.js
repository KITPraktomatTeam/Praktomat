(function(a){a.fn.formset=function(c){var r=a.extend({},a.fn.formset.defaults,c),o=r.extraClasses.join(" "),g=a("#id_"+r.prefix+"-TOTAL_FORMS"),l=a("#id_"+r.prefix+"-MAX_NUM_FORMS"),f="input,select,textarea,label,div",p=a(this),b=function(t,s){if(r.extraClasses){t.removeClass(o);t.addClass(r.extraClasses[s%r.extraClasses.length])}},q=function(v,w,t){var s=new RegExp(w+"-(\\d+|__prefix__)-"),u=w+"-"+t+"-";if(v.attr("for")){v.attr("for",v.attr("for").replace(s,u))}if(v.attr("id")){v.attr("id",v.attr("id").replace(s,u))}if(v.attr("name")){v.attr("name",v.attr("name").replace(s,u))}},i=function(s){return s.find(f).length>0},m=function(){return l.length==0||(l.val()==""||(l.val()-g.val()>0))},h=function(s){if(s.is("TR")){s.children(":last").append('<a class="'+r.deleteCssClass+'" href="javascript:void(0)">'+r.deleteText+"</a>")}else{if(s.is("UL")||s.is("OL")){s.append('<li><a class="'+r.deleteCssClass+'" href="javascript:void(0)">'+r.deleteText+"</a></li>")}else{s.append('<a class="'+r.deleteCssClass+'" href="javascript:void(0)">'+r.deleteText+"</a>")}}s.find("a."+r.deleteCssClass.replace(/\s+/g,".")).click(function(){var y=a(this).parents("."+r.formCssClass),t=y.find('input:hidden[id $= "-DELETE"]'),x=y.siblings("a."+r.addCssClass+", ."+r.formCssClass+"-add"),u;if(t.length){t.val("on");y.hide();u=a("."+r.formCssClass).not(":hidden")}else{y.remove();u=a("."+r.formCssClass).not(".formset-custom-template");g.val(u.length)}for(var v=0,w=u.length;v<w;v++){b(u.eq(v),v);if(!t.length){u.eq(v).find(f).each(function(){q(a(this),r.prefix,v)})}}if(x.is(":hidden")&&m()){x.show()}if(r.removed){r.removed(y)}return false})};p.each(function(t){var u=a(this),s=u.find('input:checkbox[id $= "-DELETE"]');if(s.length){if(s.is(":checked")){s.before('<input type="hidden" name="'+s.attr("name")+'" id="'+s.attr("id")+'" value="on" />');u.hide()}else{s.before('<input type="hidden" name="'+s.attr("name")+'" id="'+s.attr("id")+'" />')}a('label[for="'+s.attr("id")+'"]').hide();s.remove()}if(i(u)){u.addClass(r.formCssClass);if(u.is(":visible")){h(u);b(u,t)}}});if(p.length){var d=!m(),k,n;if(r.formTemplate){n=(r.formTemplate instanceof a)?r.formTemplate:a(r.formTemplate);n.removeAttr("id").addClass(r.formCssClass+" formset-custom-template");n.find(f).each(function(){q(a(this),r.prefix,"__prefix__")});h(n)}else{n=a("."+r.formCssClass+":last").clone(true).removeAttr("id");n.find('input:hidden[id $= "-DELETE"]').remove();n.find(f).not(r.keepFieldValues).each(function(){var s=a(this);if(s.is("input:checkbox")||s.is("input:radio")){s.attr("checked",false)}else{s.val("")}})}r.formTemplate=n;if(p.attr("tagName")=="TR"){var e=p.eq(0).children().length,j=a('<tr><td colspan="'+e+'"><a class="'+r.addCssClass+'" href="javascript:void(0)">'+r.addText+"</a></tr>").addClass(r.formCssClass+"-add");p.parent().append(j);if(d){j.hide()}k=j.find("a")}else{p.filter(":last").after('<a class="'+r.addCssClass+'" href="javascript:void(0)">'+r.addText+"</a>");k=p.filter(":last").next();if(d){k.hide()}}k.click(function(){var t=parseInt(g.val()),u=r.formTemplate.clone(true).removeClass("formset-custom-template"),s=a(a(this).parents("tr."+r.formCssClass+"-add").get(0)||this);b(u,t);u.insertBefore(s).show();u.find(f).each(function(){q(a(this),r.prefix,t)});g.val(t+1);if(!m()){s.hide()}if(r.added){r.added(u)}return false})}return p};a.fn.formset.defaults={prefix:"form",formTemplate:null,addText:"add another",deleteText:"remove",addCssClass:"add-row",deleteCssClass:"delete-row",formCssClass:"dynamic-form",extraClasses:[],keepFieldValues:"",added:null,removed:null}})(jQuery);