{% extends "base.html" %}
{% load i18n %}{% load in_group %}
{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{{MEDIA_URL}}/frameworks/jquery/jquery.tools.min.js"></script>
<script type="text/javascript">	
 $(document).ready(function(){
 	$("#help_icon").tooltip({
		position:  "center left"
	});
	$("#edit_soluton_button").click(function(){
		location.href = $("#user_selector")[0].value;
	});
	$("#attest_selected_user_button").click(function(){
		location.href = $("#solution_selector")[0].value;
	});
 })

</script>
{% endblock %}
{% block breadcrumbs %} {{block.super}} > <a href={% url task_detail task_id=task.id%}>{{task.title}}</a> > Attestations{% endblock %}
{% block content %}<div id='attestation_list'>

<h1>{{task.title}}</h1>

<div id='help_icon'><span class="icon icon-orange ui-icon-info"></span></div>
<div class="tooltip"> 
	<span class="icon ui-icon-radio-on icon-orange" title="not finished"></span> <a>not finished</a><br/>
	<span class="icon ui-icon-check icon-green" title="final unpublished"></span> <a>final but unpublished</a><br/>
	<span class="icon ui-icon-circle-check icon-green" title="final published"></span> <a>final and published</a><br/>
	<span class="icon ui-icon-search" title="view only"></span> <a>view only</a><br/>
</div> 

{% if not task.expired %}
	<p>{% trans "The task is not yet expired." %}</p>
{% else %}
	{% if not task.all_checker_finished %}
		<p>{% trans "Not all checker have yet been run." %}</p>
	{% else %}
	
		<div id="Solutions">
			<a href={% url solution_download_for_task task_id=task.id %} id='download'><span class="ui-icon ui-icon-disk" title="Download all solutions"></span></a>
			{% if tutored_users %}
				<select id="user_selector">
					{% for user in tutored_users %}
						<option value="{% url solution_list task_id=task.id user_id=user.id %}">{{user.last_name}}, {{user.first_name}}</option>
					{% endfor %}
				</select>
				<input id="edit_soluton_button" type="button" value="Edit Solutions"/></br></br>
			{% endif %}			
			
			{% if user|in_group:'Trainer'%}
				<h2>{% trans "Attestation Progress by Tutor" %}</h2>
				<div class='attestation'>
					<table>
					{% for entry in attestation_stats %}
						<tr>
                                                      <td>{{entry.tutor.first_name}} {{entry.tutor.last_name}}</td>
                                                      <td align="right">{{entry.final}} final</td><td> + </td><td align="right">{{entry.nonfinal}} nonfinal</td><td>=</td> 
                                                      <td align="right">{{entry.attested}}</td><td>of</td><td align="right">{{entry.total}}</td>
                                                </tr>
					{% endfor %}
					</table>
				</div>

				<h2>{% trans "Unatested solutions" %}</h2>
				<div class='attestation'>
					{% for solution in unatested_solutions %}
						<span class="icon ui-icon-search" title="view only"></span> <a href="{% url solution_detail solution_id=solution.id %}">Solution by {{solution.author}}</a></br>
					{% empty %}
						<p>All solutions have been attested.</p>
					{% endfor %}
				</div>
			{% endif %}
			
			{% if user|in_group:'Tutor'%}
				{% if show_author %}
					<select id="solution_selector" {% if unatested_solutions|length == 0 %}disabled="disabled"{% endif %}>
						{% for solution in unatested_solutions %}
						<option value="{% url new_attestation_for_solution solution_id=solution.id %}">{{solution.author.last_name}}, {{solution.author.first_name}}</option>
						{% endfor %}
					</select>
					<input id="attest_selected_user_button" type="button" value="Attest selected user" {% if unatested_solutions|length == 0 %}disabled="disabled"{% endif %}/>
				{% else %}
					<input id="next_attestation_button" type="button" value="Attest next solution" {% if unatested_solutions|length == 0 %}disabled="disabled"{% endif %} onclick="location.href ='{% url new_attestation_for_task task_id=task.id %}'"/> 
				{% endif %}
				{{ unatested_solutions|length }} solutions to attest.</br></br></br>
			{% endif %}
			
			{% if solutions_with_plagiarism %}
				{% if show_author %}
			<span class='plagiarism error'><span class="icon ui-icon-alert icon-red"></span>The solutions of{% for solution in solutions_with_plagiarism %} {{solution.author}}{%if not forloop.last%}, {%endif%}{% endfor %} have been marked as plagiarism.</span>
				{% else %}
					<span class='plagiarism error'><span class="icon ui-icon-alert icon-red"></span>{{solutions_with_plagiarism|length}} solutions have been marked as plagiarism.</span>
				{% endif %}
			{% endif %}
			
			{% if my_attestations %}
				<h2>{% trans "My attestations" %}</h2>
				{% for attestation in my_attestations%}
					<div class='attestation'>
						{% if attestation.final %}
							{% if attestation.published %}
								<span class="icon ui-icon-circle-check icon-green" title="final published"></span>
							{% else %}
								<span class="icon ui-icon-check icon-green" title="final unpublished"></span>
							{% endif %}
						{% else %}
							<span class="icon ui-icon-radio-on icon-orange" title="not finished"></span>
						{% endif %}
						<a href={% url edit_attestation attestation_id=attestation.id%}>
							Attestation for {% if show_author %}{{attestation.solution.author}}{% else %}Solution {{forloop.counter}}{% endif %}
						</a>
						{% if attestation.solution.plagiarism %}
							<span class='plagiarism error'><span class="icon ui-icon-alert icon-red"></span>{% trans "Marked as Plagiarism" %}</span>
						{% endif %}
						<span id='comment'>{{ attestation.private_comment|truncatewords:15}}</span>
						<br/>
					</div>
				{% endfor %}
			{% endif %}
			
			
			{% if attestations_by_others %}
				<h2>{% trans "Attestations by other tutors" %}</h2>
				{% for attestation in attestations_by_others%}
					<div class='attestation'>
						<span class="icon ui-icon-search" title="view only"></span>
						<a href={% url view_attestation attestation_id=attestation.id%}>Attestation for {% if show_author %}{{attestation.solution.author}}{% else %}Solution {{forloop.counter}}{% endif %}</a> by {{attestation.author}}
						{% if attestation.solution.plagiarism %}
							<span class='plagiarism error'><span class="icon ui-icon-alert icon-red"></span>{% trans "Marked as Plagiarism" %}</span>
						{% endif %}
						<span id='comment'>{{ attestation.private_comment|truncatewords:15}}</span>
						<span style="float:right">Created: {{attestation.created|date:"Y-m-d H:i"}}</span>
						<br/>
					</div>
				{% endfor %}
			{% endif %}
			
			
			
			
			
			{% if not user|in_group:'Trainer'%}
				<form enctype="multipart/form-data" method="post" action="">{% csrf_token %}	
					<input type="submit" value="Publish all final attestations" {% if published %} disabled {% endif %}/>
					{% if published %}	
						<span id='comment'>All attested Solutions are allready published.</span> 
					{% endif %}
				</form>
			{% endif %}
		</div>
	{% endif %}
{% endif %}
</div>{% endblock %}
